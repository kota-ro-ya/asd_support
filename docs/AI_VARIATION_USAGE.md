# AI バリエーション機能の使い方

## 📖 概要

AI バリエーション機能を使うと、床屋や トイレなどの各場面で、**毎回異なる状況と選択肢**を体験できます。

---

## 🎮 使い方（3 ステップ）

### ステップ 1：イベント選択画面で設定

イベント選択画面（「🌟 ○○ さん、今日はどこへ行こう？」の画面）で、以下の設定を行います：

#### ✅ 必須：AI バリエーションをオンにする

```
[ ✓ ] 🤖 AIバリエーション
```

このチェックを**オン**にすると、AI が内容を生成します。

#### ⚙️ オプション：毎回新しく生成

```
[ ✓ ] 🔄 毎回新しく生成
```

- **オン（推奨）**: 場面 1、場面 2 ともに**毎回完全に異なる**内容が生成されます
- **オフ**: 一度生成された内容は 24 時間キャッシュされます（同じ内容が表示される）

---

### ステップ 2：イベントを選択

例：「床屋」を選択

---

### ステップ 3：ストーリーを体験

- **場面 1**: AI が生成した状況と選択肢が表示されます
- **場面 2**: 再度 AI が新しい状況を生成します（「🔄 毎回新しく生成」がオンの場合）

---

## 🔄 具体例：床屋の場合

### 固定テンプレート（AI バリエーションオフ）

**場面 1**（毎回同じ）

```
美容師さんに「今日はどんな髪型にしますか？」と聞かれました。
どうする？

選択肢：
1. 「短くしてください」と伝える（適切）
2. 黙っている（不適切）
3. 指で長さを示す（許容）
```

---

### AI バリエーション（毎回新しく生成）

**1 回目の場面 1**

```
床屋に入ると、大きな鏡と椅子が見えました。
座る椅子を選んでね。

選択肢：
1. 空いている椅子に座る（適切）
2. 立ったまま待つ（許容）
3. 好きな椅子を探し回る（不適切）
```

**2 回目の場面 1**（別の日にプレイ）

```
床屋さんの入口で、「いらっしゃい」と声をかけられたよ。
どうする？

選択肢：
1. 「こんにちは」と挨拶する（適切）
2. 頷いて会釈する（許容）
3. 無視して奥に進む（不適切）
```

**3 回目の場面 1**（さらに別の日）

```
待合室で順番を待っています。
あと2人で自分の番だよ。どうする？

選択肢：
1. 静かに座って待つ（適切）
2. 雑誌を読みながら待つ（適切）
3. 「まだですか？」と何度も聞く（不適切）
```

→ **毎回全く異なる場面が生成されます！**

---

## ⚙️ 設定の組み合わせ

| AI バリエーション | 毎回新しく生成 | 結果                                     |
| ----------------- | -------------- | ---------------------------------------- |
| ❌ オフ           | -              | 常に同じ内容（固定テンプレート）         |
| ✅ オン           | ❌ オフ        | 初回は AI 生成、その後 24 時間は同じ内容 |
| ✅ オン           | ✅ オン        | **毎回完全に異なる内容（推奨）**         |

---

## 💡 推奨設定

### 初めて使う場合

```
[✓] 🤖 AIバリエーション: オン
[✓] 🔄 毎回新しく生成: オン
```

→ 毎回新しい体験ができて飽きません！

### 同じ内容で復習したい場合

```
[✓] 🤖 AIバリエーション: オン
[ ] 🔄 毎回新しく生成: オフ
```

→ 一度生成された内容を繰り返し練習できます

### いつもの内容で学習したい場合

```
[ ] 🤖 AIバリエーション: オフ
```

→ 固定テンプレートで一貫した学習

---

## ⚠️ 注意事項

### AI 生成には時間がかかります

- **初回生成**: 2-5 秒程度
- **キャッシュ利用時**: 0.1 秒未満

### 品質チェックについて

AI が生成した内容は自動的に品質チェックされます：

- **教育的適切性**: ASD の特性に配慮しているか
- **言語的適切性**: 理解しやすい表現か
- **安全性**: 不適切な表現がないか

品質基準を満たさない場合は、自動的に固定テンプレートにフォールバックします。

---

## 🎯 学習効果

### 固定テンプレートの場合

- ✅ 一貫性が高い
- ✅ 繰り返し練習しやすい
- ❌ 暗記してしまう可能性
- ❌ 応用力が育ちにくい

### AI バリエーションの場合（毎回新しく生成）

- ✅ **応用力が育つ**
- ✅ **飽きずに学習できる**
- ✅ 実際の状況に近い多様性
- ❌ 内容が予測できない
- ❌ 生成に時間がかかる

---

## 🔧 トラブルシューティング

### 問題 1：AI バリエーションをオンにしても同じ内容が表示される

**原因**: 「🔄 毎回新しく生成」がオフになっている

**解決策**:

1. イベント選択画面に戻る
2. 「🔄 毎回新しく生成」をオンにする
3. もう一度イベントを選択

---

### 問題 2：生成に時間がかかりすぎる

**原因**: OpenAI API のレスポンスが遅い

**解決策**:

- しばらく待つ（最大 10 秒程度）
- 「🔄 毎回新しく生成」をオフにしてキャッシュを活用
- それでもダメな場合は AI バリエーションをオフにして固定テンプレートを使用

---

### 問題 3：固定テンプレートの内容が表示される

**原因**: AI 生成の品質チェックで不合格になった

**解決策**:

- 自動的にフォールバックしているため問題ありません
- もう一度試すと別の内容が生成される可能性があります
- `.env` ファイルで `AI_QUALITY_THRESHOLD` を下げると採用率が上がります

---

## 📊 データについて

### キャッシュの保存場所

```
data/cache/scenario_cache.json
```

### キャッシュのクリア方法

1. **手動でファイルを削除**

   ```bash
   rm data/cache/scenario_cache.json
   ```

2. **有効期限切れを待つ**

   - デフォルトで 24 時間後に自動削除

3. **設定で短縮**
   `.env` ファイルで：
   ```env
   CACHE_EXPIRY_HOURS=1  # 1時間に短縮
   ```

---

## 🎓 よくある質問

### Q1: AI バリエーションと固定テンプレート、どちらが良いですか？

**A**: 目的によります：

- **初めて学ぶ**: 固定テンプレート（一貫性重視）
- **応用力を育てる**: AI バリエーション（多様性重視）
- **両方使う**: まず固定で基礎を学び、慣れたら AI バリエーションで応用

### Q2: 「毎回新しく生成」をオンにするとコストが高くなりませんか？

**A**: はい、API 呼び出しが増えるため、OpenAI へのコストが増加します。

- オフの場合: 1 イベントあたり 1 回の生成（24 時間有効）
- オンの場合: プレイするたびに生成

コストを抑えたい場合は、「毎回新しく生成」をオフにすることを推奨します。

### Q3: AI が生成する内容は毎回品質が保証されていますか？

**A**: はい、以下の仕組みで品質を確保しています：

1. **品質管理エージェント**による自動チェック（80 点以上）
2. 不合格の場合は**再生成**（最大 3 回）
3. それでもダメな場合は**固定テンプレート**にフォールバック

---

## 📖 関連ドキュメント

- **AI Agent Implementation**: `docs/AI_AGENT_IMPLEMENTATION.md`
- **Quick Start**: `QUICKSTART.md`
- **Implementation Summary**: `docs/AI_GENERATION_SUMMARY.md`

---

**最終更新**: 2025 年 11 月 1 日  
**バージョン**: 1.1
