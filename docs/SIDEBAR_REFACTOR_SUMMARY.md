# サイドバー機能の刷新 - 専門エージェントシステムへの統一

## 📋 変更内容

**サイドバーの「保護者向け AI 相談」を専門エージェントシステムに統一**

---

## 🎯 目的

### 課題

1. **機能の重複**

   - サイドバーの「シチュエーション別ガイドモード」
   - メインページの「保護者向けシチュエーション別ガイド」
     → 完全に重複、かつサイドバーの方が機能的に劣る

2. **一貫性の欠如**

   - メインページ：専門エージェントシステム（4 人の専門家）
   - サイドバー：従来の AI 人格（3 種類）のみ
     → ユーザーが混乱

3. **品質の差**
   - 従来の AI 人格：シンプルな 1 対 1 の回答
   - 専門エージェントシステム：多角的で高精度な回答
     → 品質に大きな差

### 解決策

**サイドバーを専門エージェントシステムに統一**

- ✅ 重複機能の削除
- ✅ 全体で一貫した高品質な回答
- ✅ シンプルで分かりやすい UI

---

## 🔧 実装した変更

### 変更 1：シチュエーション別ガイドモードを削除 ✅

**理由**：メインページと完全重複

**Before（サイドバー）**：

```
🎭 保護者向けAI相談
├─ モードを選ぶ
│  ├─ よくある質問モード
│  └─ シチュエーション別ガイドモード ← 削除
├─ AIの話し方を選ぶ（3種類）
└─ 質問入力
```

**After（サイドバー）**：

```
👥 保護者向けAI相談
├─ 専門家チーム紹介
├─ よくある質問（5件ランダム）
├─ 回答形式選択（統合/個別）
└─ 自由に質問
```

### 変更 2：AI 人格選択を削除 ✅

**理由**：専門エージェントシステムでは不要

**Before**：

- 🩺 ロジカルドクター
- 🍀 やさしい先生
- 🌞 応援コーチ

**After**：

- 🧠 臨床心理士（ASD 専門）
- ⚕️ 小児科医（発達障害専門）
- 🏫 特別支援教育専門家
- 💙 家族支援専門家

→ **常に 4 人の専門家が協調して回答**

### 変更 3：よくある質問を専門エージェントシステムに変更 ✅

**Before**：

```python
# AI人格のプロンプトのみ
ai_service.answer_parent_question_stream(question, ai_mode)
```

**After**：

```python
# 専門エージェントシステム
specialized_service = SpecializedAgentService()
result = specialized_service.generate_comprehensive_response(
    question=question,
    context=""
)
```

### 変更 4：回答形式の選択を追加 ✅

**新機能**：

- **統合回答（推奨）**：4 人の専門家の意見をまとめた回答
- **各専門家の個別回答**：それぞれの専門家の回答を個別表示

**メリット**：

- ユーザーが回答形式を選べる
- 統合回答で簡潔に、個別回答で詳しく

---

## 📊 Before & After の比較

### 機能比較

| 項目         | Before（従来）                   | After（専門エージェント）        |
| ------------ | -------------------------------- | -------------------------------- |
| **AI 人格**  | 3 種類（ロジカル/やさしい/応援） | 4 人の専門家（固定）             |
| **回答の質** | シンプル                         | 高度（多角的・エビデンスベース） |
| **モード数** | 2 つ（FAQ / シチュエーション）   | 1 つ（FAQ のみ）                 |
| **重複**     | あり（シチュエーション）         | なし                             |
| **一貫性**   | なし（メインと異なる）           | あり（全体で統一）               |

### UI 比較

#### Before

```
┌─────────────────────────────────┐
│ 🎭 保護者向けAI相談             │
├─────────────────────────────────┤
│ モードを選ぶ                    │
│ ○ よくある質問モード            │
│ ○ シチュエーション別ガイドモード│
├─────────────────────────────────┤
│ AIの話し方を選ぶ                │
│ ○ 🩺 ロジカルドクター           │
│ ○ 🍀 やさしい先生               │
│ ○ 🌞 応援コーチ                 │
├─────────────────────────────────┤
│ 💡 よくある質問                 │
│ ・質問1                         │
│ ・質問2                         │
│ ...                             │
│ [🤔 AIに聞く]                   │
└─────────────────────────────────┘
```

#### After

```
┌─────────────────────────────────┐
│ 👥 保護者向けAI相談             │
├─────────────────────────────────┤
│ 🎓 専門家チームが回答           │
│ 🧠 臨床心理士 / ⚕️ 小児科医      │
│ 🏫 特別支援教育 / 💙 家族支援   │
├─────────────────────────────────┤
│ 💡 よくある質問                 │
│ ・質問1                         │
│ ・質問2                         │
│ ...                             │
│                                 │
│ 回答形式                        │
│ ○ 統合回答（推奨）              │
│ ○ 各専門家の個別回答            │
│                                 │
│ [💬 専門家チームに質問する]     │
├─────────────────────────────────┤
│ ✍️ 自由に質問                   │
│ [質問入力欄]                    │
│ [📝 この質問を専門家チームに聞く]│
└─────────────────────────────────┘
```

→ **シンプルで分かりやすく、高機能**

---

## 🎨 ユーザー体験の向上

### 質問：「ハサミの音を怖がるのはなぜですか？」

#### Before（従来の AI 人格）

**ロジカルドクターの回答**：

```
感覚過敏が原因と考えられます。
ASDのお子さんは聴覚が敏感な場合があり、
ハサミの音が不快に感じられることがあります。
イヤーマフの使用や、事前に音を聞かせて慣れさせる方法が
効果的です。
```

→ **シンプルだが浅い**

#### After（専門エージェントシステム）

**統合回答**：

```
## 📋 専門家の共通見解
ハサミの音への恐怖は「聴覚過敏」という神経学的な特性であり、
保護者の育て方の問題ではありません。

## 🔍 それぞれの専門的視点

### ⚕️ 医学的観点（小児科医）
聴覚過敏は、前頭葉による「音のフィルタリング」機能の弱さに
よるものです。ハサミの音は約60-70dBですが、感覚過敏がある
場合は80-90dBに感じられます。
（参考: DSM-5, 日本小児神経学会ガイドライン2020）

### 🧠 心理・行動的観点（臨床心理士）
Wolpe(1958)の段階的脱感作法が有効です：
1. まず、ハサミの「写真」を見せる
2. 次に、ハサミの「音」を動画で聞く
3. 実物のハサミを「見る」だけ
4. ハサミで紙を切る様子を「見る」
5. 自分で使ってみる

各ステップは1週間以上かけ、無理は禁物です。

### 🏫 教育的観点（特別支援教育専門家）
学校でも同様の配慮が必要です。工作の授業で配慮を依頼しましょう。
合理的配慮として認められています（障害者差別解消法）。

### 💙 家族支援の観点（家族支援専門家）
保護者を責めていませんか？これは特性であり、
育て方の問題ではありません。

## 💡 具体的なアクションプラン
1. **最優先**: イヤーマフの購入（NRR20-25）
2. **次のステップ**: 段階的脱感作（週1回）
3. **並行して**: 学校の先生に相談

## ⚠️ 注意点
- パニックが1時間以上続く場合は専門医に相談
- 強制すると「トラウマ化」のリスク

## 📚 参考情報
- Wolpe, J. (1958). Systematic Desensitization
- DSM-5: Sensory Processing Disorder
- 文科省「合理的配慮の具体例」(2012)

---
💙 **保護者の皆さまへ**
ハサミを使えないことで、ご自身を責めていませんか？
お子さんのペースで、一歩一歩進めていきましょう。
```

→ **詳細・多角的・実践的・エビデンスベース** ✨

---

## 📈 期待される効果

### 1. 品質の向上

- ❌ Before: シンプルな回答
- ✅ After: 多角的で高精度な回答

### 2. 一貫性の確保

- ❌ Before: メインページと異なる回答形式
- ✅ After: 全体で統一された専門家チームの回答

### 3. ユーザー体験の向上

- ❌ Before: 機能が重複して混乱
- ✅ After: シンプルで分かりやすい

### 4. 保守性の向上

- ❌ Before: 2 つのシステムを保守
- ✅ After: 専門エージェントシステムのみ

---

## 🔄 ユーザーへの影響

### 既存ユーザー

**変更点**：

- ✅ サイドバーの「シチュエーション別ガイドモード」が削除
  → メインページの「保護者向けシチュエーション別ガイド」を使用してください

- ✅ サイドバーの「AI 人格選択」が削除
  → 常に 4 人の専門家チームが回答します（品質向上）

- ✅ 「よくある質問」の回答がより詳細に
  → 専門家チームによる高精度な回答

**メリット**：

- 回答の質が大幅に向上
- よりシンプルで使いやすい UI
- メインページとの一貫性

### 新規ユーザー

**特徴**：

- 専門家チーム（4 人）による高品質な回答
- 統合回答 or 個別回答を選べる
- よくある質問（ランダム 5 件）+ 自由質問
- どのページからでもアクセス可能（サイドバー）

---

## 📁 変更したファイル

### 1. `app/components/sidebar.py`

**変更内容**：

- ✅ シチュエーション別ガイドモード削除（`render_situation_guide_mode()` 削除）
- ✅ AI 人格選択削除
- ✅ `render_faq_mode()` を専門エージェントシステムに変更
- ✅ UI をシンプル化

**Before**：300 行
**After**：200 行（100 行削減）

### 2. `docs/SIDEBAR_REFACTOR_SUMMARY.md`（このファイル）

**内容**：

- 変更内容の詳細
- Before & After 比較
- ユーザーへの影響

---

## 🎓 技術的な詳細

### 専門エージェントシステムの利用

```python
from app.services.specialized_agent_service import SpecializedAgentService

specialized_service = SpecializedAgentService()

# 統合回答を生成
result = specialized_service.generate_comprehensive_response(
    question=selected_question,
    context=""
)

# 統合回答
synthesized_response = result['synthesized_response']

# 個別回答
individual_responses = result['individual_responses']
for agent_id, response in individual_responses.items():
    agent_info = specialized_service.get_agent_info(agent_id)
    print(f"{agent_info['icon']} {agent_info['name']}: {response}")
```

### 回答形式の選択

```python
response_mode = st.radio(
    "回答形式",
    ["統合回答（推奨）", "各専門家の個別回答"],
    key="sidebar_response_mode"
)

if response_mode == "統合回答（推奨）":
    # 統合回答を表示
    st.markdown(result['synthesized_response'])
else:
    # 個別回答を表示
    for agent_id, response in result['individual_responses'].items():
        with st.expander(f"{agent_info['icon']} {agent_info['name']}"):
            st.markdown(response)
```

---

## ✅ まとめ

### 変更の要点

1. **重複機能の削除**

   - シチュエーション別ガイドモード削除

2. **専門エージェントシステムへの統一**

   - よくある質問 → 専門家チームの回答
   - AI 人格選択 → 削除（常に 4 人の専門家）

3. **UI のシンプル化**

   - モード選択不要
   - 一目で分かる専門家チーム紹介

4. **品質の向上**
   - 多角的な視点
   - エビデンスベース
   - 実践的なアドバイス

### 今後の展望

**将来的な改善案**：

- ✨ 質問履歴の表示
- ✨ お気に入り質問の保存
- ✨ 専門家ごとの回答傾向の分析

---

**最終更新**: 2025 年 11 月 1 日  
**バージョン**: 2.0  
**変更**: サイドバーを専門エージェントシステムに統一
