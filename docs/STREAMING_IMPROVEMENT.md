# ストリーミング表示 & 柔らかい口調の実装

## 📋 実装内容

**保護者向け AI 相談のユーザー体験を大幅に改善**

---

## 🎯 解決した問題

### 問題 1：待ち時間が長すぎる

**Before**：

- 4 人の専門家が個別に回答（4 回の API 呼び出し）
- さらに統合回答を生成（1 回の API 呼び出し）
- **合計 5 回の API 呼び出し** → 30 秒以上
- その間、何も表示されない → ❌ 苦痛

**After**：

- **簡易モード**：1 人の専門家が高速回答（1 回の API 呼び出し）→ **3-5 秒** ⚡
- **詳細モード**：4 人の専門家チームの統合回答をストリーミング表示 → 3 秒後から回答が流れ始める ✅

### 問題 2：回答が固い

**Before**：

```
## 📋 専門家の共通見解
ハサミの音への恐怖は「聴覚過敏」という神経学的な特性であり、
保護者の育て方の問題ではありません。

## 🔍 それぞれの専門的視点

### ⚕️ 医学的観点（小児科医）
聴覚過敏は、前頭葉による「音のフィルタリング」機能の弱さに
よるものです...
```

→ **専門的だが堅苦しい** ❌

**After（フレンドリー口調）**：

```
お子さんがハサミの音を怖がるんですね。

実はこれ、「聴覚過敏」という特性で、
お子さんには音が大きく聞こえているんです。

脳の「音のフィルター」がうまく働かないため、
普通の人には 60dB の音が、お子さんには
80dB 以上に聞こえているかもしれません。

でも、心配しないでください！
いくつか効果的な方法があります...
```

→ **親しみやすく、読みやすい** ✅

---

## 🔧 実装した機能

### 1. ストリーミング表示 ✅

回答がリアルタイムで徐々に表示されます。

#### SpecializedAgentService の新メソッド

```python
# 簡易モード（高速）
for chunk in specialized_service.generate_quick_response_stream(
    question=question,
    context=context,
    tone="friendly"
):
    full_answer += chunk
    answer_placeholder.markdown(full_answer)

# 詳細モード（4人の専門家チーム）
for chunk in specialized_service.generate_comprehensive_response_stream(
    question=question,
    context=context,
    tone="friendly"
):
    full_answer += chunk
    answer_placeholder.markdown(full_answer)
```

### 2. 簡易モード（高速） ✅

1 人の専門家による高速回答

**特徴**：

- 3-5 秒で回答開始
- 簡潔で分かりやすい
- 日常的な相談に最適

**待ち時間**：

- Before: 30 秒間何も表示されない
- After: 3 秒後から回答が流れ始める

### 3. フレンドリー口調 ✅

親しみやすく柔らかい表現

**特徴**：

- 「〜ですね」「〜なんです」といった柔らかい語尾
- 「お子さん」「保護者の方」といった温かい呼びかけ
- 専門用語を使うが、必ずかみ砕いた説明

**口調の比較**：

| 標準                                         | フレンドリー                               |
| -------------------------------------------- | ------------------------------------------ |
| 「〜である」                                 | 「〜なんです」                             |
| 「ASD 児」                                   | 「お子さん」                               |
| 「実施してください」                         | 「〜してみましょう」                       |
| 「前頭葉による音のフィルタリング機能の弱さ」 | 「脳の『音のフィルター』がうまく働かない」 |

### 4. UI の改善 ✅

**サイドバー**：

```
💬 簡易回答（早い・おすすめ）
📚 詳細回答（4人の専門家チーム）

😊 フレンドリー（おすすめ）
📖 標準
```

**メインページ（保護者向けシチュエーション別ガイド）**：

```
💬 簡易回答（早い・おすすめ）
📚 詳細回答（4人の専門家チーム）

😊 フレンドリー
📖 標準
```

---

## 📊 Before & After の比較

### 待ち時間の体感

#### 簡易モード

| 項目               | Before                | After                 |
| ------------------ | --------------------- | --------------------- |
| **API 呼び出し**   | 5 回                  | 1 回                  |
| **待ち時間**       | 30 秒                 | 3-5 秒                |
| **体感**           | ❌ 何も表示されず待つ | ✅ すぐに回答が始まる |
| **ストリーミング** | なし                  | あり                  |

#### 詳細モード

| 項目               | Before                | After                                |
| ------------------ | --------------------- | ------------------------------------ |
| **API 呼び出し**   | 5 回                  | 5 回（ただし統合のみストリーミング） |
| **待ち時間**       | 30 秒                 | 15-20 秒                             |
| **体感**           | ❌ 何も表示されず待つ | ✅ 3 秒後から回答が流れる            |
| **ストリーミング** | なし                  | あり                                 |

### 回答の質

#### フレンドリー口調

**質問**：「ハサミの音を怖がるのはなぜですか？」

##### Before（標準口調）

```
## 📋 専門家の共通見解
ハサミの音への恐怖は「聴覚過敏」という神経学的な特性である。

## 🔍 医学的観点
聴覚過敏は、前頭葉による「音のフィルタリング」機能の弱さによるものである。
DSM-5 における感覚処理障害として分類されている。

## 💡 具体的な方法
1. イヤーマフを使用すること
2. 段階的脱感作法を実施すること
3. 合理的配慮を学校に依頼すること
```

→ **専門的だが堅苦しい** ❌

##### After（フレンドリー口調）

```
お子さんがハサミの音を怖がるんですね。
お母さん（お父さん）も、どうしてだろうと心配されていることと思います。

実はこれ、「聴覚過敏」という特性なんです。
お子さんには、音が大きく聞こえているんですね。

専門的には「感覚処理」の特性と言って、
脳の「音のフィルター」がうまく働かないため、
普通の人には 60dB くらいの音が、
お子さんには 80dB 以上に感じられているかもしれません。

でも、心配しないでください！
効果的な方法がいくつかあります。

**まず試してほしいこと**

1. **イヤーマフを使ってみましょう**
   耳当てタイプの防音具です。
   Amazonなどで「子供用 イヤーマフ」で検索すると
   2000円くらいで買えます。

2. **少しずつ慣れていく方法もあります**
   いきなりハサミを使わなくても大丈夫。
   まずは写真を見る → 動画で音を聞く →
   実物を見る → 使っているところを見る
   というように、ゆっくり進めていきましょう。

3. **学校の先生にも相談してみましょう**
   工作の時間に配慮してもらえることがあります。
   「合理的配慮」として認められているので、
   遠慮しなくて大丈夫ですよ。

**こんな時は相談を**

- パニックが 1 時間以上続く場合
- 日常生活に大きく支障が出ている場合

その際は、小児科や児童精神科に相談してみてください。

💙 **保護者の皆さまへ**

ハサミを使えないことで、ご自身を責めていませんか？
これはお子さんの特性であって、育て方の問題ではありません。
お子さんのペースで、一歩一歩進めていきましょう。

一緒に頑張りましょうね！
```

→ **親しみやすく、実践的で、励まし** ✅

---

## 🎨 ユーザー体験の改善

### シーン 1：よくある質問（サイドバー）

#### Before

```
[質問選択]
「ハサミの音を怖がるのはなぜですか？」

○ 統合回答（推奨）
○ 各専門家の個別回答

[💬 専門家チームに質問する] ← クリック

🤔 4人の専門家が相談しています...
（30秒間、何も表示されず待つ）← ❌ 苦痛

---
【統合回答】
## 📋 専門家の共通見解
（かたい文章が一気に表示）
```

#### After

```
[質問選択]
「ハサミの音を怖がるのはなぜですか？」

○ 💬 簡易回答（早い・おすすめ）
○ 📚 詳細回答（4人の専門家チーム）

○ 😊 フレンドリー（おすすめ）
○ 📖 標準

[💬 専門家に質問する] ← クリック

💭 専門家が考えています...

（3秒後から徐々に表示開始）← ✅ 快適
---
👥 専門家からの回答:

お子さんがハサミの音を怖がるんですね。

実はこれ、「聴覚過敏」という特性で、
お子さんには音が大きく聞こえているんです。
（文章が徐々に流れる）

脳の「音のフィルター」がうまく働かないため...
（続く）
```

### シーン 2：シチュエーション別ガイド（メインページ）

#### Before

```
[対応選択後]
「📚 より詳細な解説を聞く」← クリック

🤔 専門家チームが詳細な解説を作成中...
（30秒間、何も表示されず待つ）← ❌ 苦痛

---
【詳細な解説】
## 📋 専門家の共通見解
（かたい文章が一気に表示）
```

#### After

```
[対応選択後]
「📚 より詳細な解説を聞く」← クリック

💭 専門家が詳細な解説を作成中...

（3秒後から徐々に表示開始）← ✅ 快適
---
💬 専門家からの詳細な解説

この対応、とてもいい選択ですね！

実はこの方法には、いくつかの
大切なポイントがあるんです...
（文章が徐々に流れる・フレンドリー口調）
```

---

## 📈 期待される効果

### 1. 待ち時間の大幅短縮 ⭐⭐⭐

- 簡易モード：30 秒 → **3-5 秒**（6-10 倍速）
- 詳細モード：体感として大幅改善（ストリーミング表示）

### 2. ユーザー体験の向上 ⭐⭐⭐

- ❌ Before: 何も表示されず待つ → 苦痛
- ✅ After: すぐに回答が流れ始める → 快適

### 3. 読みやすさの向上 ⭐⭐⭐

- ❌ Before: 堅苦しい専門的な表現
- ✅ After: 親しみやすく柔らかい表現

### 4. 柔軟性 ⭐⭐

- ユーザーが速度と詳しさを選べる
- ユーザーが口調を選べる

---

## 🔄 ユーザーへの影響

### 既存ユーザー

**変更点**：

- ✅ **簡易回答モード**が追加されました（早くておすすめ！）
- ✅ **フレンドリー口調**が追加されました（読みやすくておすすめ！）
- ✅ 回答がストリーミング表示されるようになりました（待ち時間が快適に！）

**使い方**：

1. **急いでいる時**：簡易回答 + フレンドリー → 3-5 秒
2. **じっくり知りたい時**：詳細回答 + フレンドリー → 15-20 秒（ストリーミング）
3. **専門的に知りたい時**：詳細回答 + 標準 → 15-20 秒（ストリーミング）

### 新規ユーザー

**おすすめの使い方**：

- 😊 **フレンドリー** + 💬 **簡易回答** ← デフォルトでおすすめ！
- 読みやすく、早く、実践的

---

## 📁 変更したファイル

### 1. `app/services/specialized_agent_service.py`

**追加したメソッド**：

- `generate_quick_response_stream()`: 簡易モード（ストリーミング）
- `generate_comprehensive_response_stream()`: 詳細モード（ストリーミング）

**新機能**：

- ストリーミング表示対応
- フレンドリー口調 / 標準口調の切り替え
- 簡易モード（1 人の専門家、高速）

### 2. `app/components/sidebar.py`

**変更内容**：

- ストリーミング表示に対応
- 簡易回答 / 詳細回答の選択を追加
- フレンドリー / 標準の口調選択を追加

### 3. `app/pages/parent_guide.py`

**変更内容**：

- 「より詳細な解説を聞く」をストリーミング表示に変更（簡易モード・フレンドリー口調）
- 「複数の専門家に詳しく質問する」をストリーミング表示に変更
- 簡易回答 / 詳細回答の選択を追加
- フレンドリー / 標準の口調選択を追加

---

## 🎓 技術的な詳細

### ストリーミング表示の実装

```python
# OpenAI API のストリーミングモード
stream = self.client.chat.completions.create(
    model=self.model,
    messages=[
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_message}
    ],
    temperature=0.8,
    stream=True  # ← ストリーミング有効化
)

# Streamlit でリアルタイム表示
answer_placeholder = st.empty()
full_answer = ""

for chunk in stream:
    if chunk.choices[0].delta.content:
        full_answer += chunk.choices[0].delta.content
        answer_placeholder.markdown(full_answer)  # リアルタイム更新
```

### 口調の切り替え

```python
if tone == "friendly":
    system_prompt = """
あなたは子育て支援の経験が豊富な、やさしい専門家です。

【口調の特徴】
- 「〜ですね」「〜なんです」といった柔らかい語尾
- 「お子さん」「保護者の方」といった温かい呼びかけ
- 専門用語は使うが、必ずかみ砕いた説明を付ける
"""
else:  # standard
    system_prompt = """
あなたはASD支援の専門家チームの代表として回答します。
エビデンスベースで専門的な回答を提供してください。
"""
```

---

## ✅ まとめ

### 実装の要点

1. **ストリーミング表示**

   - 回答がリアルタイムで流れる
   - 待ち時間の体感が大幅改善

2. **簡易モード（高速）**

   - 1 人の専門家による高速回答
   - 3-5 秒で回答開始
   - 日常的な相談に最適

3. **フレンドリー口調**

   - 親しみやすく柔らかい表現
   - 読みやすく、実践的
   - 保護者に寄り添う姿勢

4. **柔軟性**
   - ユーザーが速度と詳しさを選べる
   - ユーザーが口調を選べる

### 今後の展望

**将来的な改善案**：

- ✨ 回答の途中でストップできる機能
- ✨ 音声読み上げ機能
- ✨ お気に入りの口調を保存

---

**最終更新**: 2025 年 11 月 1 日  
**バージョン**: 3.0  
**変更**: ストリーミング表示 & 柔らかい口調の実装
